# M3U8 视频下载器 - Tauri 桌面版使用指南

## 📖 目录

1. [项目简介](#项目简介)
2. [环境准备](#环境准备)
3. [快速开始](#快速开始)
4. [功能说明](#功能说明)
5. [常见问题](#常见问题)
6. [技术原理](#技术原理)

---

## 项目简介

这是一个使用 **Tauri 2.0** 封装的 M3U8 视频下载器桌面应用。

### 为什么选择 Tauri？

**浏览器版本的限制：**
- ❌ 只能保存到系统下载文件夹
- ❌ 大文件下载受限（通常 2-4GB）
- ❌ 需要 HTTPS 环境才能使用 Service Worker
- ❌ 浏览器安全策略限制多

**Tauri 桌面版的优势：**
- ✅ **自由选择保存位置** - 原生文件保存对话框
- ✅ **无大小限制** - 支持任意大小的视频下载
- ✅ **完整浏览器环境** - 所有原有功能完全可用
- ✅ **跨平台支持** - Windows、macOS、Linux 一键打包
- ✅ **零代码改动** - 100% 保留原项目架构
- ✅ **更好的性能** - 原生应用启动更快

### 核心特性

```
┌─────────────────────────────────────────┐
│      Tauri 桌面应用                      │
│  ┌───────────────────────────────────┐  │
│  │   完整浏览器环境（WebView）       │  │
│  │                                   │  │
│  │  • M3U8 播放列表解析              │  │
│  │  • 多线程并发下载 TS 片段         │  │
│  │  • AES-128 加密自动解密           │  │
│  │  • MP4 格式转码                   │  │
│  │  • Blob 下载（所有平台）          │  │
│  │  • StreamSaver 流式下载           │  │
│  │    (Windows/Linux)                │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                          │
│  🔥 Tauri 拦截下载 → 原生保存对话框      │
│  → 用户自由选择保存位置 → 完成！         │
└─────────────────────────────────────────┘
```

---

## 环境准备

### 1. 安装 Node.js

**macOS:**
```bash
# 使用 Homebrew
brew install node

# 或使用 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 20
nvm use 20
```

**Windows:**
- 下载安装包：https://nodejs.org/
- 选择 LTS 版本（推荐 v20.x）

**Linux (Ubuntu/Debian):**
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

验证安装：
```bash
node --version  # 应显示 v20.x.x
npm --version   # 应显示 10.x.x
```

### 2. 安装 Rust

**所有平台:**
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

安装完成后，重启终端，验证：
```bash
rustc --version  # 应显示 rustc 1.x.x
cargo --version  # 应显示 cargo 1.x.x
```

### 3. 平台特定依赖

**macOS:**
```bash
xcode-select --install
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install libwebkit2gtk-4.1-dev \
    build-essential \
    curl \
    wget \
    file \
    libxdo-dev \
    libssl-dev \
    libayatana-appindicator3-dev \
    librsvg2-dev
```

**Windows:**
- 安装 Visual Studio 2022 Community Edition
- 勾选 "C++ 桌面开发" 工作负载
- 或安装 Build Tools for Visual Studio 2022

---

## 快速开始

### 方法一：使用快速启动脚本（推荐）

```bash
cd m3u8-downloader
./quick-start.sh
```

然后按提示选择操作：
- `1` - 开发模式运行
- `2` - 打包应用
- `3` - 仅安装依赖

### 方法二：手动命令

#### 1. 安装依赖
```bash
cd m3u8-downloader
npm install
```

#### 2. 开发模式运行
```bash
npm run tauri dev
```

**首次运行说明：**
- ⏰ 需要编译 Rust 依赖，预计 5-10 分钟
- 💡 编译完成后会自动打开应用窗口
- 🔄 后续运行启动速度很快（几秒）

#### 3. 打包应用
```bash
npm run tauri build
```

**打包时间：**
- 预计 10-15 分钟
- 包含优化编译和代码签名

**打包输出位置：**
- **macOS:** `src-tauri/target/release/bundle/dmg/M3U8 Downloader_1.0.0_*.dmg`
- **Windows:** `src-tauri/target/release/bundle/msi/M3U8 Downloader_1.0.0_*.msi`
- **Linux:**
  - DEB: `src-tauri/target/release/bundle/deb/m3u8-downloader_1.0.0_*.deb`
  - AppImage: `src-tauri/target/release/bundle/appimage/m3u8-downloader_1.0.0_*.AppImage`

---

## 功能说明

### 1. 下载 M3U8 视频

#### 步骤 1：输入 M3U8 链接
在界面顶部输入框中粘贴 M3U8 播放列表地址，例如：
```
https://example.com/video/playlist.m3u8
```

#### 步骤 2：选择下载模式

**原格式下载（TS 格式）：**
- 点击 "原格式下载" 按钮
- 直接保存为 TS 格式，无需转码
- 速度最快

**转码为 MP4 下载：**
- 点击 "转码为 MP4 下载" 按钮
- 自动转码为 MP4 格式
- 兼容性更好

**特大视频流式下载（推荐大文件）：**
- 点击 "特大视频流式下载" 按钮
- 边下载边保存，内存占用低
- 适合超大视频（>2GB）
- **注意：** macOS 会自动降级为 Blob 模式

#### 步骤 3：选择保存位置
- 🔥 Tauri 会弹出原生文件保存对话框
- 自由选择保存位置（不受限制！）
- 自定义文件名
- 点击"保存"开始下载

#### 步骤 4：等待下载完成
- 界面显示实时下载进度
- 显示下载速度
- 显示已下载片段数量

### 2. 高级功能

#### 自定义下载线程数
- 默认：6 个并发线程
- 可调整范围：1-10
- 更多线程 = 更快下载速度（需要网络支持）

#### AES 加密自动处理
- 自动检测 M3U8 中的加密信息
- 自动下载 AES Key
- 自动解密 TS 片段
- 用户无需任何操作

#### 跨域请求自动处理
- Tauri 内置 CORS 代理
- 自动处理跨域问题
- 无需额外配置

### 3. 下载模式详解

#### Blob 模式（所有平台）

**工作原理：**
```
下载所有 TS 片段 → 内存中缓存 →
AES 解密（如需要） → MP4 转码（如需要） →
生成 Blob 对象 → Tauri 拦截下载 →
原生保存对话框 → 完成！
```

**优点：**
- ✅ 所有平台支持
- ✅ 稳定可靠
- ✅ 转码质量好

**缺点：**
- ⚠️ 内存占用高（视频大小 ≈ 内存占用）
- ⚠️ 不适合超大文件（>4GB）

**适用场景：**
- 中小型视频（<2GB）
- 需要 MP4 转码
- macOS 平台

#### StreamSaver 流式模式（Windows/Linux）

**工作原理：**
```
下载 TS 片段 → 边下载边解密 →
边转码边写入流 → Tauri 拦截下载 →
原生保存对话框 → 边下载边保存 → 完成！
```

**优点：**
- ✅ 内存占用极低（<100MB）
- ✅ 支持超大文件（无限制）
- ✅ 下载速度快

**缺点：**
- ⚠️ macOS 不支持（自动降级为 Blob）

**适用场景：**
- 超大视频（>2GB）
- Windows/Linux 平台
- 内存受限环境

---

## 常见问题

### Q1: 首次运行为什么这么慢？

**A:** 首次运行需要编译 Rust 依赖（约 450+ 个包），预计 5-10 分钟。后续运行启动速度很快（几秒）。

### Q2: macOS 上无法使用流式下载？

**A:** macOS 的 WKWebView 对 Service Worker 支持有限，StreamSaver 会自动降级为 Blob 模式。功能完全正常，只是内存占用稍高。

**解决方案：**
- 小文件（<2GB）：无影响
- 大文件（>2GB）：建议在 Windows/Linux 上下载

### Q3: 下载失败怎么办？

**可能原因及解决方法：**

1. **M3U8 链接无效**
   - 检查链接是否正确
   - 尝试在浏览器中直接访问

2. **网络问题**
   - 检查网络连接
   - 尝试使用 VPN
   - 减少并发线程数

3. **服务器限制**
   - 某些服务器限制并发请求
   - 减少线程数到 2-3
   - 更换时间段重试

4. **AES Key 无法下载**
   - 检查 Key URL 是否可访问
   - 可能需要特定 Headers（暂不支持）

### Q4: 能否下载加密视频？

**A:** 支持标准 AES-128 加密的 M3U8 视频。程序会自动：
- 解析 `#EXT-X-KEY` 标签
- 下载 AES Key
- 解密 TS 片段

**不支持：**
- DRM 加密（Widevine、FairPlay 等）
- 自定义加密算法

### Q5: 为什么内存占用这么高？

**A:** Blob 模式下，需要将整个视频缓存在内存中。

**解决方法：**
- 使用流式下载（Windows/Linux）
- 关闭其他占用内存的应用
- 下载完成后内存会自动释放

### Q6: 打包后的应用体积为什么这么大？

**A:** Tauri 应用包含：
- WebView 运行时（macOS 复用系统，Windows 内置 Edge WebView2）
- Rust 编译后的二进制文件
- 应用资源和图标

**典型体积：**
- macOS: 5-10 MB
- Windows: 15-20 MB（包含 WebView2 安装器）
- Linux: 10-15 MB

### Q7: 如何设置自定义 User-Agent？

**A:** 暂不支持。当前版本使用默认 User-Agent。

**计划支持：**
- v1.1.0 将添加设置界面
- 支持自定义 Headers

### Q8: 能否同时下载多个视频？

**A:** 当前版本不支持队列下载。建议：
- 单个下载完成后再开始下一个
- 或打开多个应用窗口（不推荐）

**计划支持：**
- v1.2.0 将添加下载队列功能

### Q9: 转码后的 MP4 质量如何？

**A:** 使用 mux.js 进行转码：
- 无损转封装（不重新编码）
- 保持原始视频质量
- 仅改变容器格式（TS → MP4）

### Q10: 如何卸载应用？

**macOS:**
```bash
# 将应用拖到废纸篓
# 或使用命令
rm -rf /Applications/M3U8\ Downloader.app
```

**Windows:**
- 控制面板 → 程序和功能 → 卸载
- 或使用原始 .msi 安装包卸载

**Linux (DEB):**
```bash
sudo apt remove m3u8-downloader
```

**Linux (AppImage):**
```bash
# 直接删除 .AppImage 文件即可
rm M3U8\ Downloader.AppImage
```

---

## 技术原理

### 1. Tauri 架构

Tauri 使用系统原生 WebView，不打包整个浏览器引擎：

```
┌─────────────────────────────────────────┐
│           Tauri Application             │
├─────────────────────────────────────────┤
│  Frontend (WebView)   │  Backend (Rust) │
│  ├─ HTML/CSS/JS       │  ├─ 窗口管理     │
│  ├─ Vue.js            │  ├─ 文件系统     │
│  ├─ M3U8 下载逻辑     │  ├─ HTTP 插件    │
│  └─ 浏览器 API        │  └─ IPC 通信     │
└─────────────────────────────────────────┘
```

### 2. WebView 对比

| 平台    | WebView 引擎    | 版本               | 说明                |
|---------|-----------------|--------------------|--------------------|
| macOS   | WKWebView       | Safari 同版本      | 系统内置，无需额外占用 |
| Windows | Edge WebView2   | Chromium 内核      | 首次运行自动安装    |
| Linux   | WebKitGTK       | WebKit 最新版      | 需要系统依赖        |

### 3. 下载流程详解

#### Blob 下载流程（所有平台）

```javascript
// 1. 解析 M3U8
const segments = parseM3U8(playlistUrl)

// 2. 并发下载 TS 片段
const promises = segments.map(seg => downloadSegment(seg))
const tsData = await Promise.all(promises)

// 3. AES 解密（如需要）
if (encrypted) {
    const key = await downloadKey(keyUrl)
    tsData = tsData.map(ts => aesDecrypt(ts, key))
}

// 4. MP4 转码（如需要）
let finalData = tsData
if (needTranscode) {
    finalData = muxToMP4(tsData)
}

// 5. 生成 Blob 并触发下载
const blob = new Blob(finalData, { type: 'video/mp4' })
const url = URL.createObjectURL(blob)
const a = document.createElement('a')
a.href = url
a.download = fileName
a.click()  // 🔥 Tauri 在这里拦截！

// 6. Tauri 拦截下载
// → 弹出原生文件保存对话框
// → 用户选择位置
// → 保存文件
// → 完成！
```

#### StreamSaver 流式下载流程（Windows/Linux）

```javascript
// 1. 注册 Service Worker
await navigator.serviceWorker.register('./serviceworker.js')

// 2. 创建可写流
const fileStream = streamSaver.createWriteStream(fileName)
const writer = fileStream.getWriter()

// 3. 边下载边写入
for (const segment of segments) {
    const data = await downloadSegment(segment)

    // 解密（如需要）
    if (encrypted) {
        data = aesDecrypt(data, key)
    }

    // 写入流
    await writer.write(new Uint8Array(data))
}

// 4. 关闭流
await writer.close()

// 5. Tauri 拦截
// → 原生保存对话框
// → 完成！
```

### 4. vs 纯 Web 版本

| 特性           | Web 版本              | Tauri 版本           |
|----------------|-----------------------|----------------------|
| 运行环境       | 浏览器                | 桌面应用             |
| 下载位置       | 固定下载文件夹        | ✅ 自由选择          |
| 大文件支持     | 受限（2-4GB）         | ✅ 无限制            |
| Service Worker | 需要 HTTPS            | ✅ 无要求            |
| 内存占用       | 受浏览器限制          | ✅ 更灵活            |
| CORS 问题      | 需要服务器配置        | ✅ 自动处理          |
| 启动速度       | 即开即用              | 需要启动应用         |
| 离线使用       | 需要 Service Worker   | ✅ 完全离线          |
| 更新机制       | 刷新页面              | ✅ 应用自动更新      |

---

## 更新日志

### v1.0.0 (2025-10-27)
- ✅ 初始版本发布
- ✅ 完整迁移原项目功能
- ✅ 支持 Windows、macOS、Linux
- ✅ Blob 下载模式（所有平台）
- ✅ StreamSaver 流式下载（Windows/Linux）
- ✅ 原生文件保存对话框
- ✅ AES-128 加密自动解密
- ✅ MP4 转码支持
- ✅ 多线程并发下载
- ✅ 实时进度显示

### 计划功能（v1.1.0）
- [ ] 下载队列管理
- [ ] 自定义 Headers 支持
- [ ] 代理设置
- [ ] 下载历史记录
- [ ] 自动更新功能
- [ ] 主题切换（暗色模式）

---

## 反馈与支持

遇到问题？欢迎反馈！

- 📧 Email: your-email@example.com
- 🐛 Issue: https://github.com/your-repo/issues
- 💬 讨论: https://github.com/your-repo/discussions

---

**祝你使用愉快！🎉**
